---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: upload-garbage-collector
  namespace: chat4all
  labels:
    app: chat4all
    component: upload-gc
    tier: worker
spec:
  # Run daily at 2 AM UTC (T095)
  schedule: "0 2 * * *"
  
  # Keep last 3 successful and 1 failed job history
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  
  # Don't start new job if previous one is still running
  concurrencyPolicy: Forbid
  
  # Keep the job for 24 hours after completion for debugging
  ttlSecondsAfterFinished: 86400
  
  jobTemplate:
    metadata:
      labels:
        app: chat4all
        component: upload-gc
        tier: worker
    spec:
      # Job timeout: 1 hour
      activeDeadlineSeconds: 3600
      
      # Retry up to 3 times on failure
      backoffLimit: 3
      
      template:
        metadata:
          labels:
            app: chat4all
            component: upload-gc
            tier: worker
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "8000"
            prometheus.io/path: "/metrics"
        spec:
          # Use service account with necessary permissions
          serviceAccountName: chat4all-worker
          
          # Restart policy for CronJob pods
          restartPolicy: OnFailure
          
          containers:
          - name: upload-gc
            image: chat4all/worker:latest
            imagePullPolicy: IfNotPresent
            
            # Run the garbage collector worker
            command:
              - python
              - -m
              - workers.upload_garbage_collector
            
            env:
              # Database Configuration
              - name: DATABASE_URL
                valueFrom:
                  secretKeyRef:
                    name: chat4all-secrets
                    key: database-url
              
              # MinIO Configuration
              - name: MINIO_ENDPOINT
                valueFrom:
                  configMapKeyRef:
                    name: chat4all-config
                    key: minio-endpoint
              
              - name: MINIO_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: chat4all-secrets
                    key: minio-access-key
              
              - name: MINIO_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: chat4all-secrets
                    key: minio-secret-key
              
              - name: MINIO_BUCKET
                valueFrom:
                  configMapKeyRef:
                    name: chat4all-config
                    key: minio-bucket
              
              - name: MINIO_SECURE
                value: "true"
              
              # Logging Configuration
              - name: LOG_LEVEL
                value: "INFO"
              
              - name: ENVIRONMENT
                value: "production"
              
              # Garbage Collection Configuration
              - name: GC_RETENTION_HOURS
                value: "24"  # Clean uploads older than 24 hours
              
              - name: GC_BATCH_SIZE
                value: "100"  # Process 100 uploads per batch
            
            resources:
              requests:
                cpu: "100m"
                memory: "256Mi"
              limits:
                cpu: "500m"
                memory: "512Mi"
            
            # Liveness probe (check if worker is healthy)
            livenessProbe:
              exec:
                command:
                  - python
                  - -c
                  - "import sys; sys.exit(0)"
              initialDelaySeconds: 10
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 3
          
          # Node selector (optional: run on specific node pool)
          nodeSelector:
            workload-type: worker
          
          # Tolerations (optional: tolerate specific taints)
          tolerations:
          - key: "workload-type"
            operator: "Equal"
            value: "worker"
            effect: "NoSchedule"
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000

---
# ConfigMap for non-sensitive configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: chat4all-config
  namespace: chat4all
data:
  minio-endpoint: "minio.chat4all.svc.cluster.local:9000"
  minio-bucket: "chat4all-files"

---
# Service Account for workers
apiVersion: v1
kind: ServiceAccount
metadata:
  name: chat4all-worker
  namespace: chat4all

---
# Role for worker permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: chat4all-worker-role
  namespace: chat4all
rules:
  # Allow reading ConfigMaps and Secrets
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list"]
  
  # Allow creating events for monitoring
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

---
# RoleBinding for worker service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: chat4all-worker-rolebinding
  namespace: chat4all
subjects:
  - kind: ServiceAccount
    name: chat4all-worker
    namespace: chat4all
roleRef:
  kind: Role
  name: chat4all-worker-role
  apiGroup: rbac.authorization.k8s.io

---
# PodDisruptionBudget (not applicable to CronJobs, but included for completeness)
# This would apply to the deployment if we run upload-gc as a long-running service
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: upload-gc-pdb
  namespace: chat4all
spec:
  minAvailable: 0  # CronJob can be disrupted
  selector:
    matchLabels:
      app: chat4all
      component: upload-gc
